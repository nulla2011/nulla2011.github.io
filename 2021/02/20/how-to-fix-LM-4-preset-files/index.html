<!DOCTYPE html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="如何修复LM-4 MarkII 的预设文件"><meta name="author" content="nulla"><meta name="keywords" content="python,vst"><meta name="copyright" content="copyright.liscense_type"><title>如何修复LM-4 MarkII 的预设文件</title><!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]><script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script><script src="https://cdn.bootcss.com/respond/1.4.2/respond.min.js"></script><![endif]--><link rel="icon"><link rel="stylesheet" href="/compass/stylesheets/font-awesome.min.css"><script>var algoliaConfig = {"on":false}</script><link rel="stylesheet" href="/compass/stylesheets/screen.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div id="body-inner-wrapper"><header id="page-header"><nav id="nav"><div id="site-name">nulla</div><i class="fa fa-bars fa-2x" id="nav-icon" aria-hidden="true"></i><div id="nav-expanded"><a class="nav-word-item" href="/">主页</a><a class="nav-word-item" href="/archives">归档</a><a class="nav-word-item" href="/tags">标签</a><a class="nav-word-item" href="/categories">分类</a><a class="nav-word-item" href="/about">关于</a></div><div id="nav-list"><ul><li><a class="nav-list-item" href="/">主页</a></li><li><a class="nav-list-item" href="/archives">归档</a></li><li><a class="nav-list-item" href="/tags">标签</a></li><li><a class="nav-list-item" href="/categories">分类</a></li><li><a class="nav-list-item" href="/about">关于</a></li></ul></div></nav><div id="banner-wrapper"><div id="banner-pagetype-dependent-info"><h1 id="post-title">如何修复LM-4 MarkII 的预设文件</h1><span id="post-description"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-02-20</span><span id="word-count">全文共 2340 字</span><span id="time-count">需阅读时间约 8 分钟</span></div></div><a title="回到顶部"><i class="fa fa-arrow-up" id="to-Top" aria-hidden="true"></i></a><a title="点击关闭目录"><i class="fa fa-toggle-on" id="toggle-on-Toc" aria-hidden="true"></i></a><a title="点击展开目录"><i class="fa fa-toggle-off" id="toggle-off-Toc" aria-hidden="true"></i></a></header><aside id="toc-column"><div id="toc-column-inner-wrapper"><div id="post-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E4%BF%AE%E5%A4%8D"><span class="toc-text">初步修复</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reso-Kit"><span class="toc-text">Reso Kit</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E7%8E%B0%E9%97%AE%E9%A2%98"><span class="toc-text">发现问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E4%BF%AE%E5%A4%8D"><span class="toc-text">手动修复</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></div></div></aside><main id="main-content-column"><div id="main-content-wrapper"><div id="post-full-content"><p>English version is <a href="https://nulla2011.github.io/2021/02/24/how-to-fix-LM-4-preset-files-en/" target="_blank" rel="noopener">here</a></p>
<p><a href="https://www.steinberg.net/en/support/unsupported_products/lm4.html" target="_blank" rel="noopener">Steinberg LM-4 MarkII</a> 是Steinberg 出品的一个鼓音源，在东方project的音乐里被频繁使用，目前早已停产。东方的音乐里用的是Processed Studio Kits，每个kit都附带一个以fxp为扩展名的预设文件。但是，在载入预设时却出现了致命bug：</p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/39143_cut.png" alt="39143_cut.png"></p>
<a id="more"></a>

<p>如图，无限弹出提示采样不存在的警告，然后插件崩溃。我用的fl studio版本是20.0.3。另外在reaper上也出现了同样的问题，但是在cakewalk上没有出现问题，插件能正常使用。（PS. 好像我以前用fl 12的时候并没有出现这个bug？）</p>
<p>虽然可以通过<code>import LM4/LM9 Script</code>来加载预设（见下图），但是还有个别的预设依然无法载入，本着刨根问底的精神，我决定一探究竟。</p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/39368_cut.png" alt="39368_cut.png"></p>
<h1 id="初步修复"><a href="#初步修复" class="headerlink" title="初步修复"></a>初步修复</h1><p>初步猜测是预设文件的问题，毕竟这是20年前的vst了，可能跟新版的fl有兼容问题。用16进制打开：</p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/Screenshot_2021-02-21_125145.png" alt="Screenshot_2021-02-21_125145.png"></p>
<p>前面可能是相对路径，后面是一个不存在的路径，总之两者都没发挥作用。于是写了个python脚本批量修改成绝对路径。完整脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">unknownBlock1 = <span class="string">b'\x00\x00\x05\x91\x00\x00\x10\x0C\x00\x00\x00\x00'</span>  <span class="comment">#0x91 or 0x93 ?</span></span><br><span class="line">unknownBlock2 = bytes.fromhex(</span><br><span class="line">    <span class="string">"000000003F80000000000001000000003F80000000000002000000003F8000000000000B0000000100000000000000000000000000000000"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convertFxp</span><span class="params">(path)</span>:</span></span><br><span class="line">    newFxpContent = <span class="string">b""</span></span><br><span class="line">    fxpName = os.path.split(path)[<span class="number">1</span>]</span><br><span class="line">    fPath = os.path.split(path)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">with</span> open(path, <span class="string">'rb'</span>) <span class="keyword">as</span> fr:</span><br><span class="line">        fxpContent = fr.read()</span><br><span class="line">        pattern = re.compile(<span class="string">br'HaSm(.|\n)*?(\\[\w ]*\\[\w ]*\.aif)'</span>)</span><br><span class="line">        pos = <span class="number">0</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            m = pattern.search(fxpContent[pos:])</span><br><span class="line">            <span class="keyword">if</span> m <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                newFxpContent += insertUnknownBlock2(fxpContent[pos:], <span class="string">b'Harp'</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            aNameWithParentDir = m.group(<span class="number">2</span>).replace(<span class="string">b"\\"</span>, <span class="string">b"\\\\"</span>)</span><br><span class="line">            repl = <span class="string">b'HaSm'</span> + unknownBlock1 + bytes(</span><br><span class="line">                doubleBackslash(fPath), <span class="string">'utf-8'</span>) + aNameWithParentDir</span><br><span class="line">            block = re.sub(pattern,</span><br><span class="line">                           repl,</span><br><span class="line">                           fxpContent[pos:pos + m.end()],</span><br><span class="line">                           count=<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> count &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">"Reso"</span> <span class="keyword">in</span> fxpName:  <span class="comment">#Reso Kit preset has multiple samples in one pad</span></span><br><span class="line">                    <span class="keyword">if</span> findHaPa(block) <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">                        block = insertUnknownBlock2(block, <span class="string">b'HaPa'</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        block = insertUnknownBlock2(block, <span class="string">b'HaSm'</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    block = insertUnknownBlock2(block, <span class="string">b'HaPa'</span>)</span><br><span class="line">            newFxpContent += block</span><br><span class="line">            pos += m.end()</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">with</span> open(fxpName, <span class="string">'wb'</span>) <span class="keyword">as</span> fw:</span><br><span class="line">        fw.write(newFxpContent)</span><br><span class="line">        print(<span class="string">"success!"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insertUnknownBlock2</span><span class="params">(chunk, reg)</span>:</span></span><br><span class="line">    pattern = re.compile(reg)</span><br><span class="line">    m = pattern.search(chunk)</span><br><span class="line">    <span class="keyword">if</span> m <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        print(<span class="string">"can't find insert position"</span>)</span><br><span class="line">        <span class="keyword">return</span> chunk</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> (chunk[:m.start()] + unknownBlock2 + chunk[m.start():])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findHaPa</span><span class="params">(chunk)</span>:</span></span><br><span class="line">    pattern = re.compile(<span class="string">b'HaPa'</span>)</span><br><span class="line">    m = pattern.search(chunk)</span><br><span class="line">    <span class="keyword">if</span> m <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">doubleBackslash</span><span class="params">(str)</span>:</span></span><br><span class="line">    str = str.replace(<span class="string">"\\"</span>, <span class="string">"\\\\"</span>)</span><br><span class="line">    str = str.replace(<span class="string">"/"</span>, <span class="string">"\\\\"</span>)</span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    installPath = input(</span><br><span class="line">        <span class="string">"Input your \"Processed Studio Kits\" folder path (ends with \"Processed Studio Kits\"):\nexample: C:\Program Files (x86)\Steinberg\Vstplugins\LM-4 MarkII\Processed Studio Kits\n"</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">assert</span> os.path.isdir(installPath), <span class="string">"illegal path"</span></span><br><span class="line">    <span class="keyword">if</span> installPath.endswith(<span class="string">"\\"</span>) <span class="keyword">or</span> installPath.endswith(<span class="string">"/"</span>):</span><br><span class="line">        installPath = installPath[:<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        fileList = os.listdir(installPath)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        print(<span class="string">"file not found"</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    fxpList = []</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> fileList:</span><br><span class="line">        <span class="keyword">if</span> f.lower().endswith(<span class="string">".fxp"</span>):</span><br><span class="line">            fxpList.append(f)</span><br><span class="line">    <span class="keyword">if</span> len(fxpList) == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">"can't find fxp files, please check directory"</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    print(<span class="string">f"found <span class="subst">&#123;len(fxpList)&#125;</span> fxp files, processing..."</span>)</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> fxpList:</span><br><span class="line">        print(<span class="string">f"converting <span class="subst">&#123;f&#125;</span> ..."</span>)</span><br><span class="line">        convertFxp(installPath + <span class="string">"\\"</span> + f)</span><br><span class="line">        <span class="keyword">if</span> f == fxpList[<span class="number">-1</span>]:</span><br><span class="line">            print(<span class="string">"all finished, converted preset files are in current folder"</span>)</span><br></pre></td></tr></table></figure>

<p>Github地址：<a href="https://github.com/nulla2011/fix-LM-4-MarkII/blob/master/fix_LM-4_fxp.py" target="_blank" rel="noopener">https://github.com/nulla2011/fix-LM-4-MarkII/blob/master/fix_LM-4_fxp.py</a></p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/Screenshot_2021-02-21_130308.png" alt="Screenshot_2021-02-21_130308.png"></p>
<p>这样fl载入预设的时候就不会报错了。（cakewalk也不会报错，但是reaper却弹出了另一个报错提示：<img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/39364.png" alt="39364.png"></p>
<p>实在不知道这个 <code>opaque data</code> 指的文件中的哪部分内容，希望有懂fxp的人能提供一些解决这个问题的思路。）</p>
<h1 id="Reso-Kit"><a href="#Reso-Kit" class="headerlink" title="Reso Kit"></a>Reso Kit</h1><p>但是，<code>04 Reso Kit.fxp</code>这个预设文件在修改后依然出现了同样的问题。之前载入script方法唯一出现问题的也是它。到底问题出在哪呢？</p>
<h2 id="发现问题"><a href="#发现问题" class="headerlink" title="发现问题"></a>发现问题</h2><p>初步观察，这个文件比其他文件大了一倍，分块跟其他文件比对了一下，发现里面提到的采样文件比其他预设多出很多，再仔细观察，采样大概是4个一组。</p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/4samples.png" alt="4samples.png"></p>
<p>用一个后面修改后成功加载的图，这里每个pad有3-4个采样，根据不同力度加载不同的采样。</p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/Screenshot_2021-02-21_153057.png" alt="Screenshot_2021-02-21_153057.png"></p>
<p>可是跑一遍上面的脚本，所有的路径已经修改完了，怎么还是加载不了采样呢？我用二分法不断尝试，终于找到了出问题的地方。</p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/Screenshot_2021-02-21_141803.png" alt="Screenshot_2021-02-21_141803.png"></p>
<p>首先我怀疑可能是名字里有星号导致的，可是换了名字并没有解决问题。然后我注意到了这个pad只包含三个采样，剩下的采样<code>R106 Rides 7.aif</code>哪去了呢？找到文件打开，发现是个无声的文件。于是我想到会不会是给这个采样留位置了但是没有写进预设里。找到其他三个采样定义力度范围的那两个字节，发现是从0~127完美连接上的，那么就不是少加采样的问题。后来我注意到了这个字节：</p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/Screenshot_2021-02-21_143052.png" alt="Screenshot_2021-02-21_143052.png"></p>
<p><code>0x04</code>是不是代表有4个采样呢？看了一下前面，这里都是<code>0x04</code>，看了一下别的预设，这里是<code>0x01</code>。尝试将其改成<code>0x03</code>，果然没有报错了：</p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/Screenshot_2021-02-21_150203.png" alt="Screenshot_2021-02-21_150203.png"></p>
<p>然而后面却空出来了三个位置，woodblock的音色却是ride。缺少的音色除了woodblock以外，还有clap和cowbells，在预设里根本搜不到clap和cowbells，这又是怎么回事呢？从图上可以看出crash是在倒数第4的位置，而它本应该在最后一个。ride在crash前面，名字却是woodblock，它的本来的位置很可能在crash本应在的位置的前一个。那么我们可以做出这样的推断：</p>
<blockquote>
<p>原本clap和cowbells是夹在woodblock与ride之间的，但是由于未知原因，woodblock的采样定义到ride的名字之间的文件内容丢失了。定义woodblock的名字还有采样数量的块（见上上图）和定义ride的采样的块拼接到了一起，woodblock有4个采样，而ride有3个采样，这就导致了无法找到采样的报错。</p>
</blockquote>
<h2 id="手动修复"><a href="#手动修复" class="headerlink" title="手动修复"></a>手动修复</h2><p>丢失的关键内容太多，要想修复只能靠脑补了。首先将没有问题的crash copy到最后；将woodblock copy一份到倒数第二的位置，改名成ride；给原先的woodblock替换并增加采样；再把两个空位填上cowbells和clap采样；最后参照其他的pad改一下每个采样的力度范围，对照<a href="https://www.midi.org/specifications-old/item/gm-level-1-sound-set" target="_blank" rel="noopener">标准midi键盘对鼓的定义</a>修改每个pad对应的键盘上的键，再改一些细节就可以了。</p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/Screenshot_2021-02-21_162740.png" alt="Screenshot_2021-02-21_162740.png"></p>
<p>可是我试了很久，都没法在改好的预设里使用相对路径，不得已只好再写个脚本让各位根据自己的路径生成预设文件了，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">fxpUrl = <span class="string">"https://gitee.com/millionlive/stepPic/raw/master/04_Reso_Kit_fix.fxp"</span></span><br><span class="line"><span class="comment">#fxpUrl= "https://cdn.jsdelivr.net/gh/nulla2011/fix-LM-4-MarkII/04_Reso_Kit_fix.fxp"</span></span><br><span class="line"><span class="comment">#fxpUrl= "https://raw.githubusercontent.com/nulla2011/fix-LM-4-MarkII/master/04_Reso_Kit_fix.fxp"</span></span><br><span class="line"></span><br><span class="line">unknownBlock1 = <span class="string">b'\x00\x00\x05\x90\x00\x00\x10\x0C\x00\x00\x00\x00'</span>  <span class="comment">#0x91 or 0x93 or 0x90?</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFxpFile</span><span class="params">(url)</span>:</span></span><br><span class="line">    print(<span class="string">"downloading file..."</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        f = request.urlopen(url)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        print(<span class="string">'Network Error, you can try another fxpUrl'</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replacePath</span><span class="params">(data, path)</span>:</span></span><br><span class="line">    newContent = <span class="string">b""</span></span><br><span class="line">    pattern = re.compile(</span><br><span class="line">        <span class="string">br'HaSm(.|\n)*?E:\\Steinberg\\Vstplugins\\LM-4 MarkII\\Processed Studio Kits\\04 Reso Kit\\([\w ]*\.aif)'</span></span><br><span class="line">    )</span><br><span class="line">    pos = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        m = pattern.search(data[pos:])</span><br><span class="line">        <span class="keyword">if</span> m <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            newContent += data[pos:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        fName = m.group(<span class="number">2</span>)</span><br><span class="line">        repl = <span class="string">b'HaSm'</span> + unknownBlock1 + bytes(path.replace(</span><br><span class="line">            <span class="string">"\\"</span>, <span class="string">"\\\\"</span>), <span class="string">'utf-8'</span>) + <span class="string">b'\\\\04 Reso Kit\\\\'</span> + fName</span><br><span class="line">        newContent += re.sub(pattern, repl, data[pos:pos + m.end()], count=<span class="number">1</span>)</span><br><span class="line">        pos += m.end()</span><br><span class="line">    <span class="keyword">return</span> newContent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    installPath = input(</span><br><span class="line">        <span class="string">"Input your \"Processed Studio Kits\" folder path (ends with \"Processed Studio Kits\"):\nexample: C:\Program Files (x86)\Steinberg\Vstplugins\LM-4 MarkII\Processed Studio Kits\n"</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">assert</span> os.path.isdir(installPath), <span class="string">"illegal path"</span></span><br><span class="line">    <span class="keyword">if</span> installPath.endswith(<span class="string">"\\"</span>) <span class="keyword">or</span> installPath.endswith(<span class="string">"/"</span>):</span><br><span class="line">        installPath = installPath[:<span class="number">-1</span>]</span><br><span class="line">    fxpData = getFxpFile(fxpUrl)</span><br><span class="line">    print(<span class="string">f"converting to new fxp..."</span>)</span><br><span class="line">    newFxpContent = replacePath(fxpData, installPath)</span><br><span class="line">    <span class="keyword">with</span> open(installPath + <span class="string">"\\04 Reso Kit_fix.fxp"</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> fw:</span><br><span class="line">        fw.write(newFxpContent)</span><br><span class="line">    print(<span class="string">f"Success, the fixed preset file path is \"<span class="subst">&#123;installPath&#125;</span>\\04 Reso Kit_fix.fxp\""</span>)</span><br></pre></td></tr></table></figure>

<p>使用方法：输入<code>Processed Studio Kits</code>的完整目录，然后运行完脚本就会在目录里生成一个<code>04 Reso Kit_fix.fxp</code>的文件。</p>
<p>这个脚本我也放在了<a href="https://github.com/nulla2011/fix-LM-4-MarkII" target="_blank" rel="noopener">上面提到的仓库</a>里。生成的预设文件在FL Studio 20.0.3、REAPER 6.01、Cakewalk中都通过了测试。哦旧预设文件在Cakewalk里都能加载啊，那没事了。</p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/Screenshot_2021-02-21_163757.png" alt="Screenshot_2021-02-21_163757.png"></p>
<p>改好的预设仍有些遗憾之处，最不确定的几个地方是上图这三个pad的音量以及力度百分比，因为原文件内容的丢失永远也不知道设置的是什么值了。其他的基本没什么改动，照搬就是了。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>最后给出懒人版总结：运行第一个脚本，输入采样所在的文件夹（以<code>Processed Studio Kits</code>结尾），在<strong>脚本的目录</strong>下就会生成修改好的预设文件，但是<code>04 Reso Kit.fxp</code>这个文件还是不能用。运行第二个脚本，还是输入采样所在的文件夹，在<strong>采样所在的目录</strong>内就会生成修改后的Reso Kit预设。</p>
<p><img src="https://gitee.com/millionlive/stepPic/raw/master/LM-4/Screenshot_2021-02-24_215105.png" alt="Screenshot_2021-02-24_215105.png"></p>
<hr>
<p><strong>20211205更新：</strong></p>
<p>应群友的要求，简单改了一下脚本。现在可以用<a href="https://github.com/nulla2011/fix-LM-4-MarkII/blob/master/fix_LM-4_disk1_fxp.py" target="_blank" rel="noopener">这个新脚本</a>来修复一部分LM4 disk1中的预设了。</p>
</div><div id="post-tags-container"><i class="fa fa-tags"></i> <a class="post-tag" href="/tags/python/">#python</a>  <a class="post-tag" href="/tags/vst/">#vst</a></div></div></main><div id="pagination-wrapper"><a id="page-prev" href="/2021/10/26/windows-terminal-and-gitbash/"><i class="fa fa-chevron-left"></i> 在右键菜单里添加 windows terminal here 并默认使用git ...</a><a id="page-next" href="/2021/01/26/compose-full-watermelon/">研究一下合成大西瓜 <i class="fa fa-chevron-right"></i></a></div><footer id="page-footer"><div id="footer-wrapper"><div id="blog-meta">&copy;2017-2022 By nulla | 主题 - <a id='theme-name' target="_blank" rel="noopener" href="https://github.com/huan555/lemon-lime"> Lemon-Lime</a> | 驱动 - <a id='theme-powered-by' href=http://hexo.io> Hexo</a></div><div id="viewed-record"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span></span></div><div id="copyright-wrapper"><i class="fa fa-cc" aria-hidden="true"></i><div id="copyright">除非有特别声明，本博客所有文章均采用 <a rel="license" href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0 协议</a>.</div></div><div id="contact-me"><div id="rss"><a href="/atom.xml" type="application/atom+xml" rel="alternate" target="_blank"><i class="fa fa-rss" aria-hidden="true"></i></a></div><span id="weibo"><a target="_blank" rel="noopener" href="https://weibo.com/nulla2011"><i class="fa fa-weibo" aria-hidden="true"></i></a></span><span id="twitter"><a target="_blank" rel="noopener" href="https://twitter.com/nulla2011"><i class="fa fa-twitter" aria-hidden="true"></i></a></span><span id="email"><a href="mailto:nulla@outlook.com"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></span><span id="youtube"><a target="_blank" rel="noopener" href="https://www.youtube.com/channel/UC8oZtp8ay0Omfl7VYOqOJFw"><i class="fa fa-youtube-play" aria-hidden="true"></i></a></span><span id="telegram"><a target="_blank" rel="noopener" href="https://t.me/nulla2011"><i class="fa fa-telegram" aria-hidden="true"></i></a></span></div></div></footer><script src="/compass/js/blog.js"></script></div></body>